name: 🎪 🖥️ 🛠️
on: push
jobs:

  rocm:
    name: 🐧 Build onnxruntime-rocm wheels
    runs-on: ubuntu-latest
    container:
      image: rocm/jax-build:rocm5.4.0-jax0.4.6.540-py3.10.0
      volumes:
        - ${{ github.workspace }}:/code
    steps:

    - uses: actions/checkout@v3
      with:
        repository: Microsoft/onnxruntime
        path: onnxruntime
        ref: rel-1.15.0
        submodules: true

    - uses: lukka/get-cmake@latest
      with:
        cmakeVersion: 3.26.3

    - name: 🛠️ 📦 install & build
      working-directory: onnxruntime
      run: python3.10 tools/ci_build/build.py
        --allow_running_as_root
        --build_dir=build/Linux
        --config=Release
        --enable_pybind
        --build_wheel
        --compile_no_warning_as_error
        --parallel
        --skip-keras-test
        --skip_tests
        --use_rocm
        --rocm_home=$ROCM_PATH

    - uses: actions/upload-artifact@v3
      with:
        path: onnxruntime/build/Linux/Release/dist/onnxruntime*.whl
